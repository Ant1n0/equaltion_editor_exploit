


#  CVE-2017-11882 Study

  
  
  
  

Student Name: Peiran Sun, Yufeng Ge


Date:2022.2.20

  
 
  

## Intro:

Today we are going to talk about a vulnerability that affects everyone who uses Microsoft office for almost two decades.

When you opened a Microsoft Office file, have you ever noticed this annoying warning?


![](https://lh3.googleusercontent.com/X9ZScLN3Q7liHkaW0E09DpayMSh-lqWYHVNWX59TPIjBvOdMbQ3lPka23v6UaTtxodJ_TJN52maVIWwBED2gQRG-t3j79gcLSxWAXTzttkVV8ZKIRyoUs0c54dzbWFn321ovTK8L)
  

I always wonder, how can a file display only text and pictures, maybe sometimes video, harming your computer?

  

After thorough research on this topic, it turns out things are more complicated than text and pictures in the Microsoft office suite. Today, we are going to talk about one of the most popular vulnerabilities researchers found inside the Microsoft office, called Microsoft Office Memory Corruption Vulnerability.

  

## Description of CVE-2017-11882:

  [CVE reference link](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2017-11882)

[Vulnerability reference link](https://www2.deloitte.com/nz/en/pages/risk/articles/cyber-intell-advisory-microsoft-office.html)
First, let us discuss a little about how this vulnerability works.

  

This vulnerability is based on a stack overflow error inside the equation editor component used by the office software. Attackers could exploit this vulnerability by designing an office file targeting this error. Once that file is opened, one could execute a script of a certain length under the user group of the current user.

The script then will be able to download and execute any remote script with no limitations on the affected host. A common choice of the payload script will be info-stealer software or ransomware.

  
  

![](https://lh5.googleusercontent.com/IC4WKfjjQ6mDOzaoJzLMOMZ8Nwexetd8AJ37x8qJ1k-53up_0DTDzBvYJcnod59KBzsyb_3WiLUgpdX9c1f2FHZXKJHxLEapG2RMeXnWkSXBVNy2qPyxrL6Vet_ETTnzG1ak7ShZ)

  [CVE reference](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2017-11882)
  
  

## Historical background:

[Main reference](https://blog.morphisec.com/microsoft-equation-editor-backdoor)
[History reference](https://en.wikipedia.org/wiki/Microsoft_Office_shared_tools#Equation_Editor)
[Equaltion editor reference](https://www.wiris.com/en/mathtype/)
[History reference 2 ](https://www2.deloitte.com/nz/en/pages/risk/articles/cyber-intell-advisory-microsoft-office.html)

So what is wrong with the office, and how do hackers exploit this?

To understand this, we need a little historical background.


In 2000, Microsoft would like to add mathematical equation functionality to its Office suite.

As a major corporation, the way Microsoft accomplished this was by using a mature product from a third party.

They purchased the license of a math equation editor and embedded that editor in every following office suite. [Reference](https://en.wikipedia.org/wiki/Design_Science_(company))

At the same time, this vulnerability that is not easy to find is also embedded in it.

For the following years, many new protection methods were added to the windows system. The office suite also got a new math editor in 2007.[Reference](https://support.microsoft.com/en-us/office/equation-editor-6eac7d71-3c74-437b-80d3-c7dea24fdf3f#ID0EDF=Newer_versions)

However, to accommodate users with older software versions, Microsoft decided to include the old editor alongside the new one, so that old files can be processed by the new software.

As for the buffer overflow bug, it is supposed to be no big deal. For modern computer OS, a small buffer overflow will soon be discovered by the operating system, and all the anti-malware utilities will brutally kill the process.

And all modern software utilized address space layout randomization. Meaning the stack memory locations are scrambled and allocated by the compiler, and the malicious script will not be able to spot buffer overflow locations even if there is one.

With all the protection, what could go wrong?

The answer is Microsoft.

 
For some reason, Microsoft has never recompiled the math equation component, hence the majority of the software-side security measures never applied to this component. Some voices mention that they lost the source code for this component, but since nothing went wrong yet, they just did not pay any attention to it.

 
Then we know what happens next. In 2017, after this vulnerability sees the sunlight and soon becomes one of the most popular windows vulnerabilities used by attackers. [Reference](https://blog.morphisec.com/microsoft-equation-editor-backdoor)

  

## CVE-2017-11882 Exploit In The Wild:

  

Microsoft quickly released a patch to fix this vulnerability. However, early versions of the office suites were license-based, many users just did not like the concept of updating software.

![](https://lh5.googleusercontent.com/HxrX26_rNYXNseoPoH4KgMOhxChChQz2z9SE2Q-kzkLX2kd2Qv9VGk-n_K6rbWj2SdLbww-DxAehUQhVvNg8mKy2DdAum61BrhT5wGbU3XEuOHOwet2ePm13VQ32kHFb6qWscok-)

For this reason, this vulnerability was quickly exploited by hacker groups all over the world. In 2020, it has been rated by the FBI as the top 10 vulnerability for hacker groups to routinely exploit.([Reference](https://www.cisa.gov/uscert/ncas/alerts/aa20-133a))

Based on the information from CVE stalker, we can see the release of the patch didn’t prevent this exploit from going wild in recent years.([CVE stalker](https://cvestalker.com/cve.php?cve=CVE-2017-11882))

  
Web analytics also found that, due to the recent conflict in Ukraine, this exploit was also used by civilian hackers and military attackers.([Reference](https://www.bleepingcomputer.com/news/security/russia-ukraine-war-exploited-as-lure-for-malware-distribution/))

  

![](https://lh6.googleusercontent.com/UnzEZohkvf1FYQ30Pv7DHmw-W3UYP8CQVOKKxJ9SEh-DpgJ1b-yUXVunTFmNQBpovN5oq5XqKOGJvCMRRWWEyhEK8PUcbHhS-2nYE9bqmrxnA7OXZ0Ueskv-itZSHlOeA5FmCCNK)
[Image reference, very interesting](https://www.bleepingcomputer.com/news/security/russia-ukraine-war-exploited-as-lure-for-malware-distribution/)
  



## How attackers use this Vulnerability：

  
[Main Reference](https://blog.morphisec.com/microsoft-equation-editor-backdoor)
[Coding reference](https://github.com/rxwx/CVE-2018-0802)
[Infection cycle reference](https://www.trendmicro.com/en_ca/research/17/l/cve-2017-11882-exploited-deliver-cracked-version-loki-infostealer.html)

So how do hackers exploit this vulnerability?

  

Remember from the course that a stack-overflow may enable the hacker to execute any malicious code. And we have one inside the office equation editor process. For the reasons Peiran discussed, that process is not well protected.

  
  

Furthermore, the office suite supports a file notation known as Rich Text Format. It was to allow the display of more media files inside office documents. For example pictures, charts, even some videos. And math equations can also be expressed using this format.

  

Hence, to demonstrate the exploit concept, we only need to open an RTF file targeting this vulnerability. \
Here is an sample RTF file ([Sample](https://github.com/embedi/CVE-2017-11882/blob/master/example/exploit.rtf))
  

![](https://lh5.googleusercontent.com/THzZYozC8rs7y9sRgDlQWnMlkKCKt5OBgkOgMQQnXie-7xGVfRzl3SwhHxPH44uIKs7KZIGnnmXeZkEnsvc2qB1DMyggvbbW_mweJkLHnuW_bVJ8P1K_woclnWjTEF0EvseLPjsT)


It targets the math equation module of the office suite. Once executed, it will open the Windows calculator to demonstrate a successful exploit.

  
You can based on the general look of this file to see this was targeting a buffer overflow.

  
  

[This is a link to the proof of concept video of the above exploit.](https://www.youtube.com/watch?v=iUEV7rZZhf0)

  
  
  

However, even though many protection methods were invalidated, a file like this will also be detected by the anti-virus software on the local machine. Moreover, files that look so geeky and dangerous may not lure the victim into clicking them.

  

Hence here is a more common infection chain for this exploit.[Reference](https://www.trendmicro.com/en_ca/research/17/l/cve-2017-11882-exploited-deliver-cracked-version-loki-infostealer.html)

  

![https://www.trendmicro.com/content/dam/trendmicro/global/en/migrated/security-intelligence-migration-spreadsheet/trendlabs-security-intelligence/2017/12/CVE-2017-11882-loki-1.jpg](https://lh3.googleusercontent.com/sy2pQurXRlcpwcj-xm9UKPeysELqkAYV221mb4On9xzOmR5IGZqQFWOLq_deQ7D3cvqxDJtsZFgPKxTRJYs9fVhrqXV5ccHIpJ2ISO8rBNXKCexscnDLdULGNnRXVTlVQI3OwHiC)

  

It all starts with a normal email with an office document attached.

![](https://lh6.googleusercontent.com/UnzEZohkvf1FYQ30Pv7DHmw-W3UYP8CQVOKKxJ9SEh-DpgJ1b-yUXVunTFmNQBpovN5oq5XqKOGJvCMRRWWEyhEK8PUcbHhS-2nYE9bqmrxnA7OXZ0Ueskv-itZSHlOeA5FmCCNK)

The target victims will be those who need to edit the file, for example, a receipt confirmation. To accomplish that, they have to willingly disable the Microsoft-protected view.

  

Office allows a technology known as `Object Linking and Embedding`. It is a way to link RTF into your document. The link can also be specified by a URL, meaning you can store the linked object in a remote location.

Unfortunately, this also means the malicious document can be put in a distant location to avoid detection.

![](https://lh3.googleusercontent.com/TWjOttCOa3UaUfWE4cQTxJcYbRWQW21uCcU3i6Yy85WmvUeZZtEFyzKPlTJF67REni_9JSAR_6Wba7QDq8SjJCo4HWuN7ovhEeqF2oUrwPEuKQeQtSib7bZfMA9gs-_dskER5uTS)

  

In this image, you can see the infected document was requesting another external word document from a foregin website. The requested payload will be the malicious RTF.

  

Then an anomaly GET request was discovered by the web researcher soon after the file request. Meaning the malicious RTF downloaded and tried to execute a script.

![](https://lh4.googleusercontent.com/Fg4boXGPlyNEYnb9jXZZi-Mtvc01uBPvb8E2DmgkqKpmbFHnZ6nhn0VeX95qdAyeosvvxB6TIB7bM-zyUL8UkhY3FBttHumSk66eetLNjSMNy7Z6n035UFcpkvNcGBX7Q1h09P_r)

The signature of the downloaded script soon is identified as commercial Information-stealing software known as Loki.

  
  

# Aftermath
[CVE-2018-0798](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2018-0798)
[CVE-2018-0802](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2018-0802)
[Additional reference](https://news.sophos.com/en-us/2019/07/18/a-new-equation-editor-exploit-goes-commercial-as-maldoc-attacks-using-it-spike/)

Two weeks after the public release of this vulnerability, Microsoft released a security update including a patch to solve the memory overflow problem. That patch was added manually to the compiled program via reverse engineering. However, a patch does not solve the fact that this module was compiled almost two decades ago, and lacks every modern mechanism to ensure security.

Not surprisingly, this module was exploited few more times after the initial patch, documented by CVE-2018-0798 ,CVE-2018-0802 and this [article ](https://news.sophos.com/en-us/2019/07/18/a-new-equation-editor-exploit-goes-commercial-as-maldoc-attacks-using-it-spike/).
